FROM ubuntu:22.04

# è¨­ç½®ç’°å¢ƒè®Šæ•¸
ENV DEBIAN_FRONTEND=noninteractive
ENV OLLAMA_HOST=0.0.0.0

# å®‰è£ä¾è³´
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# ä¸‹è¼‰ä¸¦å®‰è£ Ollama
RUN curl -fsSL https://ollama.ai/install.sh | sh

# å‰µå»ºå·¥ä½œç›®éŒ„
WORKDIR /app

# å‰µå»ºå•Ÿå‹•è…³æœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸš€ å•Ÿå‹• Ollama æœå‹™..."\n\
\n\
# å•Ÿå‹• Ollama æœå‹™\n\
ollama serve &\n\
OLLAMA_PID=$!\n\
\n\
# ç­‰å¾…æœå‹™å•Ÿå‹•\n\
echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."\n\
sleep 10\n\
\n\
# æª¢æŸ¥æœå‹™ç‹€æ…‹\n\
until curl -s http://localhost:11434/api/tags > /dev/null; do\n\
    echo "â³ ç­‰å¾… Ollama API å°±ç·’..."\n\
    sleep 5\n\
done\n\
\n\
echo "âœ… Ollama æœå‹™å·²å•Ÿå‹•"\n\
\n\
# ä¸‹è¼‰æ¨¡å‹ (å¦‚æœä¸å­˜åœ¨)\n\
echo "ğŸ“¥ æª¢æŸ¥æ¨¡å‹..."\n\
if ! ollama list | grep -q "gpt-oss:20b"; then\n\
    echo "ğŸ“¥ ä¸‹è¼‰ gpt-oss:20b æ¨¡å‹..."\n\
    ollama pull gpt-oss:20b\n\
fi\n\
\n\
if ! ollama list | grep -q "gpt-oss:120b"; then\n\
    echo "ğŸ“¥ ä¸‹è¼‰ gpt-oss:120b æ¨¡å‹..."\n\
    ollama pull gpt-oss:120b\n\
fi\n\
\n\
echo "ğŸ‰ æ‰€æœ‰æ¨¡å‹æº–å‚™å°±ç·’ï¼"\n\
echo "ğŸ“Š å¯ç”¨æ¨¡å‹:"\n\
ollama list\n\
\n\
# ä¿æŒæœå‹™é‹è¡Œ\n\
wait $OLLAMA_PID\n\
' > /app/start.sh

# è¨­ç½®è…³æœ¬æ¬Šé™
RUN chmod +x /app/start.sh

# æš´éœ²ç«¯å£
EXPOSE 11434

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:11434/api/tags || exit 1

# å•Ÿå‹•æœå‹™
CMD ["/app/start.sh"]
